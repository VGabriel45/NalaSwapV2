{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getSolidityFilesCachePath = exports.SolidityFilesCache = void 0;\n\nconst debug_1 = __importDefault(require(\"debug\"));\n\nconst fs_extra_1 = __importDefault(require(\"fs-extra\"));\n\nconst t = __importStar(require(\"io-ts\"));\n\nconst path = __importStar(require(\"path\"));\n\nconst constants_1 = require(\"../../internal/constants\");\n\nconst log = (0, debug_1.default)(\"hardhat:core:tasks:compile:cache\");\nconst FORMAT_VERSION = \"hh-sol-cache-2\";\nconst CacheEntryCodec = t.type({\n  lastModificationDate: t.number,\n  contentHash: t.string,\n  sourceName: t.string,\n  solcConfig: t.any,\n  imports: t.array(t.string),\n  versionPragmas: t.array(t.string),\n  artifacts: t.array(t.string)\n});\nconst CacheCodec = t.type({\n  _format: t.string,\n  files: t.record(t.string, CacheEntryCodec)\n});\n\nclass SolidityFilesCache {\n  constructor(_cache) {\n    this._cache = _cache;\n  }\n\n  static createEmpty() {\n    return new SolidityFilesCache({\n      _format: FORMAT_VERSION,\n      files: {}\n    });\n  }\n\n  static async readFromFile(solidityFilesCachePath) {\n    let cacheRaw = {\n      _format: FORMAT_VERSION,\n      files: {}\n    };\n\n    if (fs_extra_1.default.existsSync(solidityFilesCachePath)) {\n      cacheRaw = await fs_extra_1.default.readJson(solidityFilesCachePath);\n    }\n\n    const result = CacheCodec.decode(cacheRaw);\n\n    if (result.isRight()) {\n      const solidityFilesCache = new SolidityFilesCache(result.value);\n      await solidityFilesCache.removeNonExistingFiles();\n      return solidityFilesCache;\n    }\n\n    log(\"There was a problem reading the cache\");\n    return new SolidityFilesCache({\n      _format: FORMAT_VERSION,\n      files: {}\n    });\n  }\n\n  async removeNonExistingFiles() {\n    for (const absolutePath of Object.keys(this._cache.files)) {\n      if (!fs_extra_1.default.existsSync(absolutePath)) {\n        this.removeEntry(absolutePath);\n        continue;\n      }\n    }\n  }\n\n  async writeToFile(solidityFilesCachePath) {\n    await fs_extra_1.default.outputJson(solidityFilesCachePath, this._cache, {\n      spaces: 2\n    });\n  }\n\n  addFile(absolutePath, entry) {\n    this._cache.files[absolutePath] = entry;\n  }\n\n  getEntries() {\n    return Object.values(this._cache.files);\n  }\n\n  getEntry(file) {\n    return this._cache.files[file];\n  }\n\n  removeEntry(file) {\n    delete this._cache.files[file];\n  }\n\n  hasFileChanged(absolutePath, contentHash, solcConfig) {\n    const {\n      isEqual\n    } = require(\"lodash\");\n\n    const cacheEntry = this.getEntry(absolutePath);\n\n    if (cacheEntry === undefined) {\n      // new file or no cache available, assume it's new\n      return true;\n    }\n\n    if (cacheEntry.contentHash !== contentHash) {\n      return true;\n    }\n\n    if (solcConfig !== undefined && !isEqual(solcConfig, cacheEntry.solcConfig)) {\n      return true;\n    }\n\n    return false;\n  }\n\n}\n\nexports.SolidityFilesCache = SolidityFilesCache;\n\nfunction getSolidityFilesCachePath(paths) {\n  return path.join(paths.cache, constants_1.SOLIDITY_FILES_CACHE_FILENAME);\n}\n\nexports.getSolidityFilesCachePath = getSolidityFilesCachePath;","map":{"version":3,"mappings":"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","names":["log","FORMAT_VERSION","CacheEntryCodec","t","type","lastModificationDate","number","contentHash","string","sourceName","solcConfig","any","imports","array","versionPragmas","artifacts","CacheCodec","_format","files","record","SolidityFilesCache","constructor","_cache","createEmpty","readFromFile","solidityFilesCachePath","cacheRaw","fs_extra_1","existsSync","readJson","result","decode","isRight","solidityFilesCache","value","removeNonExistingFiles","absolutePath","Object","keys","removeEntry","writeToFile","outputJson","spaces","addFile","entry","getEntries","values","getEntry","file","hasFileChanged","isEqual","require","cacheEntry","undefined","exports","getSolidityFilesCachePath","paths","path","join","cache","constants_1"],"sourceRoot":"","sources":["../../src/builtin-tasks/utils/solidity-files-cache.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}